<!DOCTYPE html>
<html>

<head>
    <title>
        TODO-list
    </title>
    <link rel="stylesheet" href="todo-list.css">
</head>

<body>
    <div style="text-align:center; margin:auto; width : 80%">
        <h2>TODO List</h2>
        <form style="text-align: right; margin-right:9px">
            <input type="button" id="buttonSave" value="Save" onclick="saveRearrangedTodo()">
        </form>
        <br>
        <table>
            <thead>
                <th class="text">
                    TODO:
                </th>
                <th>
                    <input type="text" id="inputNewTodo" onkeydown="keyDownEnter()">
                </th>
                <th class="button">
                    <input type="button" id="buttonNewTodo" onclick="generateTodo()" value="+New">
                </th>
            </thead>
            <tbody id="tbodyNewTodo">

            </tbody>
        </table>
        <br>
        <table>
            <thead>
                <th class="text" colspan="2">
                    TODO: &nbsp;Done
                </th>
                <th class="button">
                    <input type="button" id="buttonDoneTodo" onclick="removeTodo()" value="Clear">
                </th>
            </thead>
            <tbody id="tbodyDoneTodo">
            </tbody>
        </table>
    </div>
    <script lang="javascript">
        var arrToDo = new Array();
        loadArrToDo();
        for (var i = 0; i < generateTodo.length; i++) {
            document.getElementById("inputNewTodo").value = arrToDo[i];
            generateTodo();
        }
        function saveRearrangedTodo() {
            localStorage.clear();
            arrToDo.filter(x => x);
            saveArrToDo();
        }

        function saveArrToDo() {
            for (var i = 0; i < arrToDo.length; i++) {
                if (arrToDo[i] == null) {
                    console.log("break");
                    console.log(localStorage.getItem(i));
                    console.log(arrToDo);
                    break;
                }
                localStorage.setItem(i, arrToDo[i]);
                console.log(localStorage.getItem(i));
            }
        }
        function loadArrToDo() {
            console.log("done");
            for (var i = 0; i < localStorage.length; i++) {
                if (localStorage.getItem(i) != null) {
                    arrToDo[i] = localStorage.getItem(i);
                };
            }
        }
        function keyDownEnter() {
            var keyCode = event.keyCode;
            if (keyCode == 13) {
                generateTodo();
            }
        }
        function generateTodo(doneTodo) {
            var newTr = document.createElement("tr");
            var newTd = document.createElement("td");
            var newCheckbox = document.createElement("input");
            var index;
            var inputValue;
            if (doneTodo == null) {
                inputValue = document.getElementById("inputNewTodo").value;
                index = arrToDo.length;
                arrToDo[index] = inputValue;
                document.getElementById("inputNewTodo").value = "";
            } else {
                index = doneTodo.name;
                inputValue = arrToDo[index];
                document.getElementById("tbodyDoneTodo").removeChild(document.getElementsByName(index)[0]);
            }
            var newContent = document.createTextNode(inputValue);

            newCheckbox.setAttribute("type", "checkbox");
            newCheckbox.setAttribute("onclick", "moveToDo(this)");

            newTr.setAttribute("id", index);

            newTd.setAttribute("colspan", "3");

            newTd.appendChild(newCheckbox);
            newTd.appendChild(newContent);

            newTr.appendChild(newTd);

            document.getElementById("tbodyNewTodo").appendChild(newTr);
        }
        
        var moveToDo = function (checkbox) {
            var index = checkbox.parentNode.parentNode.getAttribute("id");
            var parentId = document.getElementById(index).parentNode.getAttribute("id");
            if (parentId == "tbodyNewTodo") {
                moveNewToDone(checkbox);
            }
            if (parentId == "tbodyDoneTodo") {
                moveDoneToNew(checkbox);
            }
        }
        var moveNewToDone = function (newCheckbox) {
            var index = newCheckbox.parentNode.parentNode.getAttribute("id");
            var doneTr = document.getElementById(index);
            document.getElementById("tbodyDoneTodo").appendChild(doneTr);
        }
        var moveDoneToNew = function (doneCheckbox) {
            var index = doneCheckbox.parentNode.parentNode.getAttribute("id");

            var newTr = document.getElementById(index);
            document.getElementById("tbodyNewTodo").appendChild(newTr);
        }
        
        function removeTodo() {
            if (document.getElementById("tbodyDoneTodo").hasChildNodes()) {
                var length = document.getElementById("tbodyDoneTodo").children.length;
                var x = document.getElementById("tbodyDoneTodo");
                for (var i = 0; i < length; i++) {
                    var index = x.lastChild.getAttribute("name");
                    delete arrToDo[index];
                    x.lastChild.remove();
                    delete arrToDo[i];
                }
            }
        } 
    </script>
</body>

</html>